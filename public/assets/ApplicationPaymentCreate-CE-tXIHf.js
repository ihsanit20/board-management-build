import{B as Q,O as F,r as T,C as z,i as _,o as tt,c as o,a as e,t as i,h as f,j as v,D as P,F as D,e as M,b as V,v as h,G as et,y as st,k as r,n as O,N as nt,d,p as lt}from"./index-DXxrbR31.js";import{u as at}from"./application-payment-Cud7D5Xo.js";import{u as ot}from"./zamat-BeKk-UwW.js";import{u as it}from"./institute-Dzl9koOx.js";const dt={class:"my-container p-4 sm:p-6"},ut={key:0,class:"mb-4 rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-800"},rt={key:1,class:"mb-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"},mt={class:"mb-5 rounded-2xl border border-slate-200 bg-white p-4"},pt={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},ct=["value"],ft={key:0,class:"mt-1 text-xs text-amber-600"},xt={class:"space-y-2"},vt={class:"grid grid-cols-1 gap-2"},bt={class:"flex gap-2"},_t=["onKeyup"],gt=["disabled"],yt={key:0,class:"far fa-spinner-third animate-spin mr-1"},ht={key:0,class:"rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm"},kt={class:"flex flex-wrap items-center gap-3"},wt={class:"font-medium"},Nt={class:"text-slate-500"},Ct={class:"text-slate-500"},St={class:"grid grid-cols-1 md:grid-cols-2 gap-2 items-end"},Ft={class:"inline-flex items-center gap-2 text-xs text-slate-600"},Tt={key:0,class:"mt-1 text-xs text-red-600"},Dt={key:0},Mt={key:0,class:"mt-1 text-xs text-red-600"},Vt={key:0,class:"mt-4 rounded-lg bg-slate-50 border border-slate-200 p-3 text-sm"},$t={class:"flex flex-wrap items-center gap-4"},Bt={class:"card-bg p-4"},Ut={class:"mb-3 flex items-center justify-between"},Et={key:0,class:"space-y-4"},Xt={class:"px-3 py-2 bg-slate-50 border-b border-slate-200 font-medium"},It={class:"p-3 grid gap-3"},Pt={class:"grid grid-cols-3 gap-3"},jt={class:"font-medium text-slate-700"},At=["onUpdate:modelValue"],Lt={class:"text-end text-slate-500"},Kt={class:"font-semibold text-slate-700"},Ot={key:1,class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Rt={class:"flex items-center justify-between gap-3"},Ht={class:"text-sm font-medium text-slate-700"},Yt=["onUpdate:modelValue"],Zt={class:"text-end text-slate-500"},Gt={class:"font-semibold text-slate-700"},Jt={class:"grid grid-cols-2"},Wt={class:"mt-4 grid text-sm text-end border rounded-md p-4"},qt={class:"grid grid-cols-2"},Qt={class:"grid grid-cols-2"},zt={class:"grid grid-cols-2 font-bold text-base"},te={class:"flex justify-center"},ee=["disabled"],se={key:0,class:"far fa-spinner-third mr-2 animate-spin"},de={__name:"ApplicationPaymentCreate",setup(ne){const $=at(),g=Q(),y=ot(),j=it(),R=lt(),l=F({exam_id:null,institute_id:null,payment_method:"Cash Payment",status:"Completed",trx_id:"",payer_msisdn:"",paid_at:null}),a=F({code:"",loading:!1,hint:"",error:!1,found:null,autoFillMsisdn:!0});async function B(){var t;a.hint="",a.error=!1,a.found=null,l.institute_id=null;const n=(t=a.code)==null?void 0:t.trim();if(!n||n.length<3){a.hint="সার্চ করতে কমপক্ষে ৩টি অক্ষর লিখুন।";return}a.loading=!0;try{const s=await j.findInstituteByCode(n);s!=null&&s.id?(a.found=s,l.institute_id=Number(s.id),a.hint=`নির্বাচিত: ${s.name} (আইডি: ${s.id})`,a.autoFillMsisdn&&s.phone&&!l.payer_msisdn&&(l.payer_msisdn=String(s.phone))):(a.hint="এই কোডে কোনো ইনস্টিটিউট পাওয়া যায়নি।",a.error=!0)}catch{a.hint=j.error||"ইনস্টিটিউট খুঁজতে ব্যর্থ হয়েছি",a.error=!0}finally{a.loading=!1}}let U=null;function H(){U&&clearTimeout(U),U=setTimeout(()=>{B()},400)}const b=T("");z(b,n=>{l.paid_at=n?n.replace("T"," ")+":00":null});const C=F({common:!1}),S=T(!1),x=T(null),k=T(""),c=_(()=>g.exams.find(n=>Number(n.id)===Number(l.exam_id))||g.exam||null),E=_(()=>{var n;return Number(((n=c.value)==null?void 0:n.registration_fee)??0)}),A=_(()=>{var n;return Number(((n=c.value)==null?void 0:n.late_fee)??0)}),w=_(()=>{if(!c.value||!b.value)return!1;const n=new Date(b.value);if(isNaN(n.getTime()))return!1;const t=(c.value.reg_last_date??"").trim();if(!t)return!1;const s=new Date(`${t}T23:59:59`);return isNaN(s.getTime())?!1:n>s}),N=_(()=>E.value+(w.value?A.value:0));function Y(){}function L(n){if(!n)return"-";try{const[t,s,u]=n.split("-").map(Number);return new Date(t,s-1,u).toLocaleDateString("bn-BD")}catch{return n}}const m=F({});function K(n){return(Number(m[n]||0)*N.value).toFixed(2)}const Z=_(()=>Object.values(m).reduce((n,t)=>n+(Number(t)||0),0)),G=_(()=>Object.entries(m).reduce((n,[,t])=>n+(Number(t)||0)*N.value,0).toFixed(2));function X(){for(const n of Object.keys(m))m[n]=0}async function J(){await g.fetchExams();const n=await g.fetchLastExam();if(!l.exam_id&&(n!=null&&n.id)&&(l.exam_id=n.id),!b.value){const t=new Date,s=u=>String(u).padStart(2,"0");b.value=`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}T${s(t.getHours())}:${s(t.getMinutes())}`}await y.fetchZamats(),(y.zamats||[]).forEach(t=>{m[t.id]==null&&(m[t.id]=0)})}function W(){l.exam_id=g.lastExamId||null,l.institute_id=null,l.payment_method="Cash Payment",l.status="Completed",l.trx_id="",l.payer_msisdn="",l.paid_at=null,a.code="",a.hint="",a.error=!1,a.found=null,a.autoFillMsisdn=!0,b.value="",x.value="",k.value="",C.common=!1,X();const n=new Date,t=s=>String(s).padStart(2,"0");b.value=`${n.getFullYear()}-${t(n.getMonth()+1)}-${t(n.getDate())}T${t(n.getHours())}:${t(n.getMinutes())}`}tt(()=>{J()});async function q(){var t,s,u;if(C.common=!0,x.value="",k.value="",!l.payment_method){x.value="পেমেন্ট মাধ্যম নির্বাচন করুন।";return}if(l.payment_method==="bkash"&&!l.trx_id){x.value="বিকাশ পেমেন্টের জন্য TRX আইডি আবশ্যক।";return}if(!l.exam_id){x.value="পরীক্ষা নির্বাচন করা আবশ্যক (উপলব্ধ থাকলে শেষ পরীক্ষাটি অটো নেওয়া হবে)।";return}if(!l.institute_id){x.value="ইনস্টিটিউট কোড দিয়ে সার্চ করে একটি ইনস্টিটিউট নির্বাচন করুন।";return}const n=[];for(const p of y.zamats){const I=Number(m[p.id]||0);I>0&&n.push({exam_id:Number(l.exam_id),institute_id:Number(l.institute_id),zamat_id:Number(p.id),amount:Number((I*N.value).toFixed(2)),payment_method:l.payment_method,status:l.status,paid_at:l.paid_at,trx_id:l.payment_method==="bkash"&&l.trx_id||null,payer_msisdn:l.payer_msisdn||null,meta:{source:"bulk-form",exam_name:((t=c.value)==null?void 0:t.name)??null,students_count:I,fee_base:E.value,fee_late:w.value?A.value:0,late_applied:w.value,institute_code:(((s=a.found)==null?void 0:s.institute_code)??a.code)||null,institute_name:((u=a.found)==null?void 0:u.name)??null}})}if(!n.length){x.value="অন্তত একটি জামাতে পরীক্ষার্থীর সংখ্যা লিখুন।";return}S.value=!0;try{const p=await $.createPaymentsBulk(n);await $.fetchPayments(),k.value=`মোট ${(p==null?void 0:p.count)??n.length}টি পেমেন্ট সফলভাবে তৈরি হয়েছে।`,X(),R.push({name:"ApplicationPaymentsByExam",params:{examId:Number(l.exam_id)}})}catch(p){x.value=$.error||(p==null?void 0:p.message)||"পেমেন্ট তৈরিতে ব্যর্থ হয়েছি"}finally{S.value=!1}}return(n,t)=>(d(),o("div",dt,[e("header",{class:"mb-5 flex flex-wrap items-center justify-between gap-3"},[t[8]||(t[8]=e("div",null,[e("h1",{class:"title-lg"},"নিবন্ধনের ফি গ্রহণ")],-1)),e("div",{class:"flex items-center gap-2"},[e("button",{class:"btn-3",onClick:W},"ফর্ম রিসেট")])]),k.value?(d(),o("div",ut,i(k.value),1)):f("",!0),x.value?(d(),o("div",rt,i(x.value),1)):f("",!0),e("section",mt,[e("div",pt,[e("div",null,[t[9]||(t[9]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},"পরীক্ষা",-1)),v(e("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>l.exam_id=s),class:"input-1",onChange:Y},[(d(!0),o(D,null,M(V(g).exams,s=>(d(),o("option",{key:s.id,value:s.id},i(s.name),9,ct))),128))],544),[[P,l.exam_id,void 0,{number:!0}]]),c.value?f("",!0):(d(),o("p",ft," কোনো পরীক্ষা নির্বাচন করা হয়নি (শেষ পরীক্ষাটি অটো সিলেক্ট করার চেষ্টা করা হবে)। "))]),e("div",null,[t[10]||(t[10]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},"পরিশোধের সময়",-1)),v(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>b.value=s),type:"datetime-local",class:"input-1"},null,512),[[h,b.value]]),t[11]||(t[11]=e("p",{class:"mt-1 text-[11px] text-slate-500"}," ডিফল্ট: বর্তমান সময়। শেষ তারিখের পরে হলে লেট ফি প্রযোজ্য। ",-1))]),e("div",xt,[e("div",vt,[t[13]||(t[13]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},"ইনস্টিটিউট কোড",-1)),e("div",bt,[v(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>a.code=s),type:"text",class:"input-1",placeholder:"যেমন: INST-0234",onInput:H,onKeyup:et(st(B,["prevent"]),["enter"])},null,40,_t),[[h,a.code,void 0,{trim:!0}]]),e("button",{class:"btn-3",type:"button",disabled:a.loading,onClick:B},[a.loading?(d(),o("i",yt)):f("",!0),t[12]||(t[12]=r(" সার্চ "))],8,gt)]),a.hint?(d(),o("p",{key:0,class:O(["text-xs",a.error?"text-red-600":"text-slate-500"])},i(a.hint),3)):f("",!0)]),a.found?(d(),o("div",ht,[e("div",kt,[e("span",wt,i(a.found.name),1),e("span",Nt,"কোড: "+i(a.found.institute_code),1),e("span",Ct,"ফোন: "+i(a.found.phone||"-"),1)])])):f("",!0),e("div",St,[e("label",Ft,[v(e("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=s=>a.autoFillMsisdn=s)},null,512),[[nt,a.autoFillMsisdn]]),t[14]||(t[14]=r(" ইনস্টিটিউটের ফোন নম্বর অটো বসাও "))])])]),e("div",null,[t[15]||(t[15]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},"দাতার ফোন",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l.payer_msisdn=s),type:"text",class:"input-1",placeholder:"017XXXXXXXX"},null,512),[[h,l.payer_msisdn,void 0,{trim:!0}]]),t[16]||(t[16]=e("p",{class:"mt-1 text-[11px] text-slate-500"}," অটো-ফিল চালু থাকলে ইনস্টিটিউটের ফোন এখানে বসবে। ",-1))]),e("div",null,[t[18]||(t[18]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},[r("মাধ্যম "),e("span",{class:"text-red-600"},"*")],-1)),v(e("select",{"onUpdate:modelValue":t[5]||(t[5]=s=>l.payment_method=s),class:"input-1"},t[17]||(t[17]=[e("option",{disabled:"",value:""},"মাধ্যম নির্বাচন করুন",-1),e("option",{value:"bkash"},"বিকাশ (bKash)",-1),e("option",{value:"Bank"},"ব্যাংক (Bank)",-1),e("option",{value:"Cash Payment"},"ক্যাশ পেমেন্ট (Cash)",-1)]),512),[[P,l.payment_method]]),C.common&&!l.payment_method?(d(),o("p",Tt," পেমেন্ট মাধ্যম নির্বাচন করুন ")):f("",!0)]),e("div",null,[t[20]||(t[20]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},"অবস্থা",-1)),v(e("select",{"onUpdate:modelValue":t[6]||(t[6]=s=>l.status=s),class:"input-1"},t[19]||(t[19]=[e("option",null,"Pending",-1),e("option",null,"Completed",-1),e("option",null,"Failed",-1),e("option",null,"Cancelled",-1)]),512),[[P,l.status]])]),l.payment_method==="bkash"?(d(),o("div",Dt,[t[21]||(t[21]=e("label",{class:"mb-1 block text-xs font-medium text-slate-600"},[r("বিকাশ TRX আইডি "),e("span",{class:"text-red-600"},"*")],-1)),v(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>l.trx_id=s),type:"text",class:"input-1",placeholder:"যেমন: 8JH3W5..."},null,512),[[h,l.trx_id,void 0,{trim:!0}]]),C.common&&!l.trx_id?(d(),o("p",Mt," বিকাশ পেমেন্টের জন্য TRX আইডি আবশ্যক ")):f("",!0)])):f("",!0)]),c.value?(d(),o("div",Vt,[e("div",$t,[e("div",null,[t[22]||(t[22]=e("span",{class:"font-medium"},"পরীক্ষা:",-1)),r(" "+i(c.value.name),1)]),e("div",null,[t[23]||(t[23]=e("span",{class:"font-medium"},"নিবন্ধন ফি:",-1)),r(" "+i(E.value),1)]),e("div",null,[t[24]||(t[24]=e("span",{class:"font-medium"},"লেট ফি:",-1)),r(" "+i(c.value.late_fee??0),1)]),e("div",null,[t[25]||(t[25]=e("span",{class:"font-medium"},"শেষ তারিখ:",-1)),r(" "+i(L(c.value.reg_last_date)),1)]),e("div",null,[t[26]||(t[26]=e("span",{class:"font-medium"},"চূড়ান্ত তারিখ:",-1)),r(" "+i(L(c.value.reg_final_date)),1)]),e("div",null,[t[27]||(t[27]=e("span",{class:"font-medium"},"লেট ফি প্রযোজ্য কিনা? ",-1)),e("span",{class:O(w.value?"text-red-600":"text-green-600")},i(w.value?"হ্যাঁ":"না"),3)])])])):f("",!0)]),e("section",Bt,[e("div",Ut,[t[29]||(t[29]=e("h3",{class:"title-md"},"মারহালা ভিত্তিক পরীক্ষার্থী",-1)),e("div",null,[t[28]||(t[28]=e("span",{class:"font-medium"},"প্রতি পরীক্ষার্থী ফি:",-1)),r(" "+i(N.value),1)]),e("button",{class:"btn-3",onClick:X,type:"button"},"সব শূন্য করুন")]),t[37]||(t[37]=e("div",{class:"grid grid-cols-3 gap-4 text-center bg-slate-100 font-bold py-1"},[e("p",null,"মারহালার নাম"),e("p",null,"পরীক্ষার্থী সংখ্যা"),e("p",null,"টাকার পরিমাণ")],-1)),V(y).departments.length?(d(),o("div",Et,[(d(!0),o(D,null,M(V(y).departments,s=>(d(),o("div",{key:s.id,class:"rounded-lg border border-slate-200"},[e("div",Xt,i(s.name)+" বিভাগ ",1),e("div",It,[(d(!0),o(D,null,M(s.zamats,u=>(d(),o("div",{key:u.id,class:"rounded-lg border border-slate-200 p-3"},[e("div",Pt,[e("div",jt,i(u.name),1),v(e("input",{placeholder:"পরীক্ষার্থী সংখ্যা",type:"number",min:"0",class:"input-1","onUpdate:modelValue":p=>m[u.id]=p},null,8,At),[[h,m[u.id],void 0,{number:!0}]]),e("div",Lt,[t[30]||(t[30]=r(" পরিমাণ: ")),e("span",Kt,i(K(u.id)),1)])])]))),128))])]))),128))])):(d(),o("div",Ot,[(d(!0),o(D,null,M(V(y).zamats,s=>(d(),o("div",{key:s.id,class:"rounded-lg border border-slate-200 p-3"},[e("div",Rt,[e("div",Ht,i(s.name),1),v(e("input",{type:"number",min:"0",class:"input-1","onUpdate:modelValue":u=>m[s.id]=u,placeholder:"পরীক্ষার্থী সংখ্যা"},null,8,Yt),[[h,m[s.id],void 0,{number:!0}]]),e("div",Zt,[t[31]||(t[31]=r(" পরিমাণ: ")),e("span",Gt,i(K(s.id)),1)])])]))),128))])),e("div",Jt,[t[35]||(t[35]=e("div",null,null,-1)),e("div",Wt,[e("div",qt,[t[32]||(t[32]=e("p",{class:"font-medium"},"মোট পরীক্ষার্থী:",-1)),e("p",null,i(Z.value)+" জন",1)]),e("div",Qt,[t[33]||(t[33]=e("p",{class:"font-medium"},"প্রতি পরীক্ষার্থী ফি:",-1)),e("p",null,i(N.value)+" টাকা",1)]),e("div",zt,[t[34]||(t[34]=e("p",{class:""},"মোট টাকার পরিমাণ:",-1)),e("p",null,i(G.value)+" টাকা",1)])])]),e("div",te,[e("button",{class:"btn-2",disabled:S.value,onClick:q},[S.value?(d(),o("i",se)):f("",!0),t[36]||(t[36]=r(" পেমেন্ট তৈরি করুন "))],8,ee)])])]))}};export{de as default};
