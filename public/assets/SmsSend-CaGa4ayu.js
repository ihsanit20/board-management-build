import{r as a,i as $,C as E,o as se,c as r,a as t,t as n,n as m,j as k,D as le,F as D,e as G,v as z,N as X,f as ae,y as q,b as oe,k as ne,h as R,d as u,L as H,p as ie,s as ue,$ as re}from"./index-4ATOSoLI.js";import{u as ce}from"./sms-D2S8bAxi.js";import{u as de}from"./institute-DDRAznN7.js";import{u as ve}from"./area-CgF9nVyD.js";const pe={class:"max-w-7xl mx-auto space-y-4 bg-white border rounded-2xl shadow p-6 sm:p-8"},ge={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"},he={class:"flex items-center gap-2 text-sm text-gray-600"},fe={class:"px-2 py-1 rounded-full bg-gray-100 border"},xe={class:"px-2 py-1 rounded-full bg-gray-100 border"},ye={class:"px-2 py-1 rounded-full bg-gray-100 border"},be={class:"px-2 py-1 rounded-full bg-gray-100 border"},me={class:"flex flex-wrap items-center gap-2"},we={class:"inline-flex rounded-lg overflow-hidden border"},_e={class:"flex items-center gap-2"},Se=["value"],ke={class:"flex items-center gap-2 ml-auto"},Ce={class:"inline-flex items-center gap-2 text-sm text-gray-700"},Ae={class:"inline-flex items-center gap-2 text-sm text-gray-700"},Me={class:"relative overflow-y-auto max-h-[320px] rounded-xl border"},Ie={class:"w-full text-left text-sm"},Te={class:"sticky top-0 bg-gray-100 z-10"},Le={class:"[&>th]:px-3 [&>th]:py-2 [&>th]:font-semibold [&>th]:text-gray-700 [&>th]:border-b"},Ve={class:"w-10"},Be=["checked"],$e={key:0},Ee={colspan:"4",class:"py-6"},Pe={key:1},je=["onClick"],Fe={class:"px-3 py-2"},Ue=["checked","onChange"],We={class:"px-3 py-2 font-mono"},Ne={class:"px-3 py-2"},Oe={class:"font-medium leading-tight"},De={key:0,class:"text-xs text-gray-500 truncate"},Ge={class:"px-3 py-2 font-medium"},ze={class:"rounded-xl border p-4 space-y-2 bg-slate-100"},Xe={class:"flex items-center justify-between gap-3"},qe={class:"font-medium"},Re={class:"text-xs text-gray-500"},He={class:"text-xs text-gray-600"},Je={class:"flex items-center justify-end gap-3"},Ke={class:"text-sm text-gray-600"},Qe=["disabled"],Ye={key:0,class:"fixed inset-0 bg-black/40 flex items-center justify-center p-4"},Ze={class:"bg-white rounded-xl p-6 w-[340px] text-center shadow-lg"},et={key:1},tt={key:0,class:"text-red-600 text-4xl"},st={key:1,class:"text-green-600 text-4xl"},lt=.5,rt={__name:"SmsSend",setup(at){const J=ue(),P=ce(),d=de(),j=ve(),g=a(""),h=a("all"),A=a(!1),f=a(!1),M=a(!1),_=a(""),c=a(""),i=a([]),w=a([]),S=a(""),K=$(()=>j.areas||[]),C=a(""),I=a(!1),T=a(!0),F=a("GSM_7BIT_EX"),U=a(0),v=a(0),x=a(160),L=a(0),Q=$(()=>i.value.length),y=$(()=>{var e;let l=[...w.value];if(T.value&&(l=l.filter(s=>s==null?void 0:s.phone)),(e=C.value)!=null&&e.trim()){const s=C.value.trim().toLowerCase();l=l.filter(o=>((o==null?void 0:o.name)||"").toLowerCase().includes(s)||((o==null?void 0:o.institute_code)||"").toLowerCase().includes(s)||((o==null?void 0:o.address)||"").toLowerCase().includes(s))}return I.value&&(l=l.filter(s=>i.value.includes(s.id))),l}),W=a(!1),V=a(null);E([()=>i.value,()=>y.value],async()=>{const l=y.value.length,e=i.value.length;W.value=l>0&&e===l,await re(),V.value&&(V.value.indeterminate=e>0&&e<l)});function B(){i.value=[]}function Y(){A.value=!0,B(),_.value="",c.value=""}async function b(l=h.value){Y(),h.value=l;try{if(l==="all")await d.fetchInstitutesWithPhone(),w.value=[...d.institutes||[]];else if(l==="centers")await d.fetchCentersWithPhone(),w.value=[...d.institutes||[]];else if(l==="withApplications")await d.fetchInstitutesWithApplications(),w.value=[...d.institutesWithApplications||[]];else if(l==="withoutApplications")await d.fetchInstitutesWithoutApplications(),w.value=[...d.institutesWithoutApplications||[]];else if(l==="area"){if(!S.value){c.value="অনুগ্রহ করে আগে এরিয়া সিলেক্ট করুন",f.value=!0;return}await d.fetchInstitutesByArea(S.value),w.value=[...d.institutesByArea||[]]}}catch{c.value="ডাটা লোড করতে সমস্যা হয়েছে",f.value=!0}finally{A.value=!1}}function N(l){const e=l.id,s=i.value.indexOf(e);s!==-1?i.value.splice(s,1):i.value.push(e)}const O=l=>i.value.includes(l.id);function Z(l){l.target.checked?i.value=y.value.map(e=>e.id):i.value=[]}async function ee(){var l;if(!((l=g.value)!=null&&l.trim())){c.value="মেসেজ লিখুন",f.value=!0;return}if(i.value.length===0){c.value="কমপক্ষে একটি ইনস্টিটিউট সিলেক্ট করুন",f.value=!0;return}f.value=!0,M.value=!0;try{const s=y.value.filter(p=>i.value.includes(p.id)).map(p=>p.phone).join(","),o=await P.sendSms({numbers:s,message:g.value});if(!(o!=null&&o.success))throw new Error("সার্ভারে SMS পাঠাতে ব্যর্থ");_.value="SMS সফলভাবে পাঠানো হয়েছে!",c.value="",g.value="",B(),setTimeout(()=>{f.value=!1,_.value="",J.push({name:"SmsLogs"})},1600)}catch(e){_.value="",c.value=(e==null?void 0:e.message)||"SMS পাঠাতে ব্যর্থ",setTimeout(()=>{f.value=!1,c.value=""},2e3)}finally{M.value=!1}}function te(){const l=g.value.length,e=/^[\x00-\x7F]*$/.test(g.value);if(F.value=e?"GSM_7BIT_EX":"UTF16",U.value=l,e)if(l===0)v.value=0,x.value=160;else if(l<=160)v.value=1,x.value=160-l;else{v.value=Math.ceil(l/153);const p=l%153;x.value=p===0?0:153-p}else if(l===0)v.value=0,x.value=70;else if(l<=70)v.value=1,x.value=70-l;else{v.value=Math.ceil(l/67);const p=l%67;x.value=p===0?0:67-p}L.value=v.value*lt}return E(g,te),E(S,l=>{h.value==="area"&&l&&b("area")}),se(async()=>{await j.fetchAreas(),await b("all")}),(l,e)=>(u(),r("div",pe,[t("div",ge,[e[10]||(e[10]=t("div",null,[t("h2",{class:"text-xl font-semibold"},"এসএমএস পাঠান"),t("p",{class:"text-sm text-gray-500"}," ফিল্টার নির্বাচন করুন, নাম্বার সিলেক্ট করুন, মেসেজ পাঠান। ")],-1)),t("div",he,[t("span",fe,"Showing: "+n(y.value.length),1),t("span",xe,"Selected: "+n(Q.value),1),t("span",ye,"Parts: "+n(v.value),1),t("span",be,"Cost: "+n(L.value)+"৳",1),t("button",{class:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-100",onClick:B}," Clear Selection ")])]),t("div",me,[t("div",we,[t("button",{class:m(["px-3 py-2 text-gray-700 bg-white hover:bg-gray-100 border-r",{"bg-cyan-600 text-white hover:bg-cyan-600":h.value==="all"}]),onClick:e[0]||(e[0]=s=>b("all"))}," সকল ",2),t("button",{class:m(["px-3 py-2 text-gray-700 bg-white hover:bg-gray-100 border-r",{"bg-cyan-600 text-white hover:bg-cyan-600":h.value==="centers"}]),onClick:e[1]||(e[1]=s=>b("centers"))}," মারকায ",2),t("button",{class:m(["px-3 py-2 text-gray-700 bg-white hover:bg-gray-100 border-r",{"bg-cyan-600 text-white hover:bg-cyan-600":h.value==="withApplications"}]),onClick:e[2]||(e[2]=s=>b("withApplications"))}," আবেদন আছে ",2),t("button",{class:m(["px-3 py-2 text-gray-700 bg-white hover:bg-gray-100",{"bg-cyan-600 text-white hover:bg-cyan-600":h.value==="withoutApplications"}]),onClick:e[3]||(e[3]=s=>b("withoutApplications"))}," আবেদন নেই ",2)]),t("div",_e,[k(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>S.value=s),class:"border rounded-lg px-3 py-2 min-w-48 focus:outline-none focus:ring-2 focus:ring-cyan-400"},[e[11]||(e[11]=t("option",{value:""},"-- এরিয়া --",-1)),(u(!0),r(D,null,G(K.value,s=>(u(),r("option",{key:s.id,value:s.id},n(s.name),9,Se))),128))],512),[[le,S.value]]),t("button",{class:m(["px-3 py-2 rounded-lg text-gray-700 bg-white hover:bg-gray-100 border",{"bg-cyan-600 text-white hover:bg-cyan-600":h.value==="area"}]),onClick:e[5]||(e[5]=s=>b("area"))}," Area অনুসারে ",2)]),t("div",ke,[k(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>C.value=s),type:"search",placeholder:"Search name/code/address…",class:"border rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-400"},null,512),[[z,C.value]]),t("label",Ce,[k(t("input",{type:"checkbox","onUpdate:modelValue":e[7]||(e[7]=s=>T.value=s),class:"accent-blue-600"},null,512),[[X,T.value]]),e[12]||(e[12]=t("span",null,"Phone only",-1))]),t("label",Ae,[k(t("input",{type:"checkbox","onUpdate:modelValue":e[8]||(e[8]=s=>I.value=s),class:"accent-blue-600"},null,512),[[X,I.value]]),e[13]||(e[13]=t("span",null,"Only selected",-1))])])]),t("div",Me,[t("table",Ie,[t("thead",Te,[t("tr",Le,[t("th",Ve,[t("input",{ref_key:"selectAllEl",ref:V,type:"checkbox",checked:W.value,onChange:Z,class:"accent-blue-600"},null,40,Be)]),e[14]||(e[14]=t("th",{class:"w-28"},"ইলহাক",-1)),e[15]||(e[15]=t("th",null,"মাদরাসার নাম ও ঠিকানা",-1)),e[16]||(e[16]=t("th",{class:"w-40"},"ফোন নাম্বার",-1))])]),t("tbody",null,[A.value?(u(),r("tr",$e,[t("td",Ee,[ae(H,{class:"shadow-none"})])])):y.value.length===0?(u(),r("tr",Pe,e[17]||(e[17]=[t("td",{colspan:"4",class:"px-4 py-6 text-center text-gray-500"},"কোনো ডাটা পাওয়া যায়নি",-1)]))):(u(!0),r(D,{key:2},G(y.value,s=>(u(),r("tr",{key:s.id,class:m(["border-b hover:bg-gray-50 cursor-pointer",{"bg-green-50":O(s)}]),onClick:o=>N(s)},[t("td",Fe,[t("input",{type:"checkbox",checked:O(s),onChange:ie(o=>N(s),["stop"]),class:"accent-blue-600"},null,40,Ue)]),t("td",We,n(s.institute_code),1),t("td",Ne,[t("div",Oe,n(s.name),1),s.address?(u(),r("div",De,n(s.address),1)):R("",!0)]),t("td",Ge,n(s.phone||"—"),1)],10,je))),128))])])]),t("div",ze,[t("div",Xe,[t("label",qe,[e[18]||(e[18]=q(" Message ")),t("span",Re,"(parts: "+n(v.value)+", "+n(F.value)+")",1)]),t("span",He,n(U.value)+" chars • left: "+n(x.value),1)]),k(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=s=>g.value=s),rows:"4",class:"border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"},null,512),[[z,g.value]]),t("div",Je,[t("span",Ke,[e[19]||(e[19]=q("Estimated Cost: ")),t("b",null,n(L.value)+"৳",1)]),t("button",{class:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:ee,disabled:oe(P).loading}," Send SMS ",8,Qe)])]),f.value?(u(),r("div",Ye,[t("div",Ze,[M.value?(u(),ne(H,{key:0,class:"shadow-none"})):(u(),r("div",et,[c.value?(u(),r("span",tt,e[20]||(e[20]=[t("i",{class:"fas fa-times-circle"},null,-1)]))):(u(),r("span",st,e[21]||(e[21]=[t("i",{class:"fas fa-check-circle"},null,-1)]))),t("p",{class:m([c.value?"text-red-600":"text-green-600","font-semibold mt-2"])},n(c.value||_.value),3)]))])])):R("",!0)]))}};export{rt as default};
